<div class="page">
  <div class="grids">
    <div class="grid-3 grid-md-2 grid-lg-2 grid-xl-2">
      <span class="label warning">💸 总市值</span>
      <h4 id="assetValue" class="text-warning"></h4>
    </div>
    <div class="grid-3 grid-md-2 grid-lg-2 grid-xl-2">
      <span class="label info">🍓 总成本</span>
      <h4 id="assetAmount" class="text-info"></h4>
    </div>
    <div class="grid-3 grid-md-2 grid-lg-2 grid-xl-2">
      <span class="label">📈 总浮盈</span>
      <h4 id="assetProfit"></h4>
    </div>
  </div>
  <div class="grids">
    <div class="grid-10 grid-md-7 grid-lg-5 grid-xl-4">
      <p class="article-title danger">市值风险比例</p>
      <div id="byrisk"></div>
    </div>
  </div>
  <div class="grids">
    <div class="grid-10 grid-md-7 grid-lg-5 grid-xl-4">
      <p class="article-title info">市值机构比例</p>
      <div id="byexcorg"></div>
    </div>
  </div>
  <p class="text-danger text-lg mg-tb-10" id="errinfobox"></p>
</div>
<script>
  ((win) => {
    // help
    let post = win.ns.post;
    let get = win.ns.get;
    let cfg = win.ns.cfg;
    let router = win.ns.router;

    //===========
    // page init
    //===========
    statistic();
    //===========
    // function
    //===========
    // 获取统计数据
    function statistic() {
      post(cfg.ApiAssetStatistic, {})
        .then(data => {
          if (data.errcode == 200) {
            $('#assetValue').text('￥' + data.Value);
            $('#assetAmount').text('￥' + data.Amount);
            $('#assetProfit').html(`<span class="${data.Profit >= 0 ? 'text-danger' : 'text-success'}">￥${data.Profit}</span>`);
            // 按风险等级
            if (data.byRisk) {
              statisticByRisk(data,data.byRisk)
            }
            // 按机构
            if (data.byExcOrg) {
              statisticByExcOrg(data, data.byExcOrg)
            }
          } else if (data.errmsg) {
            $('#errinfobox').html(data.errmsg);
          } else
            throw new Error(data);
        })
        .catch(err => {
          $('#errinfobox').html(err.message);
        });
    }
    // 按风险分组
    function statisticByRisk(total,list) {
      let th = '<tr><th>等级</th><th>比例</th><th>市值￥</th><th>成本￥</th><th>浮盈￥</th></tr>';
      let table = createTable(total, list, th, 'Risk');
      $('#byrisk').empty().html(table);
    }
    // 按机构分组
    function statisticByExcOrg(total, list) {
      let th = '<tr><th>机构</th><th>比例</th><th>市值￥</th><th>成本￥</th><th>浮盈￥</th></tr>';
      let table = createTable(total, list, th, 'ExcOrg');
      $('#byexcorg').empty().html(table);
    }
    function createTable(total, list,th,groupby) {
      let rows = '';
      for (var i = 0, len = list.length; i < len; i++) {
        let item = list[i];
        let cols = `<td>${item[groupby]}</td>`;
        cols += `<td>${(parseFloat(item.Value) / parseFloat(total.Value) * 100).toFixed(1)}%</td>`;
        cols += `<td>${item.Value}</td><td>${item.Amount}</td>`;
        cols += `<td><span class="${item.Profit >= 0 ? 'text-danger' : 'text-success'}">${item.Profit}</span></td>`;
        rows += `<tr>${cols}</tr>`;
      }
      return `<table class="table">${th}${rows}</table>`;
    }
  })(window);
</script>
